import ResponseResult from './ResponseResult';
import ResponseError from './ResponseError';
import {hasOwnProperty} from 'libs/utils/object';

export type ParcelMode =
    | 'Default'
    | 'MockSuccessFast'
    | 'MockFailureFast'
    | 'MockSuccessSlow'
    | 'MockFailureSlow'
    | 'MockSuccessImmediate'
    | 'MockFailureImmediate'
    ;

export default abstract class Parcel<T> {
    private mode: ParcelMode;
    private endpoint: string;
    private requestMethod: string;
    private requestHeaders: {[key: string]: string};
    private requestBody: null;
    private queryParams: {[key: string]: string};
    private responseContentFormat: string;
    private expectedResponseData: T | null;

    protected constructor() {
        this.mode = 'Default';
        this.endpoint = '';
        this.requestMethod = '';
        this.requestHeaders = {};
        this.requestBody = null;
        this.queryParams = {};
        this.responseContentFormat = '';
        this.expectedResponseData = null;
    }

    public setEndpoint(endpoint: string): void {
        this.endpoint = endpoint;
    }

    public setRequestMethod(method: string): void {
        this.requestMethod = method;
    }

    public setRequestHeader(name: string, value: string | number) {
        this.requestHeaders[name] = value + '';
    }

    public setQueryParam(name: string, value: string | number): void {
        this.queryParams[name] = value + '';
    }

    public setRequestBody(body: any): void {
        this.requestBody = body;
    }

    public setResponseContentFormat(responseContentFormat: string): void {
        this.responseContentFormat = responseContentFormat;
    }

    public setMode(mode: ParcelMode) {
        this.mode = mode;
    }

    public setExpectedResponseData(responseData: T): void {
        this.expectedResponseData = responseData;
    }

    public getEndpoint() {
        return this.endpoint;
    }

    public getQueryString(): string {
        let result = '';
        for (const name in this.queryParams) {
            if (!hasOwnProperty(this.queryParams, name)) {
                continue;
            }
            const value = this.queryParams[name];

            if (result.length > 0) {
                result += '&';
            }
            result += encodeURIComponent(name);
            result += '=';
            result += encodeURIComponent('string' === typeof value ? value : JSON.stringify(value));
        }

        return result;
    }

    public getRequestUrl(): string {
        const endpoint = this.getEndpoint();
        const queryString = this.getQueryString();

        if (queryString !== '') {
            return endpoint + '?' + queryString;
        }

        return endpoint;
    }

    public getRequestMethod() {
        return this.requestMethod;
    }

    public getRequestHeaders() {
        return this.requestHeaders;
    }

    public getRequestBody() {
        return this.requestBody;
    }

    public getResponseContentFormat() {
        return this.responseContentFormat;
    }

    public getMode() {
        return this.mode;
    }

    public getExpectedResponseData(): T | null {
        return this.expectedResponseData;
    }

    public onResponse(response: any): any {
    }

    public parseResponse(response: any): any {
        return response;
    }

    abstract parseResponseResult(response: any, xhr: XMLHttpRequest): ResponseResult<T | null>;

    abstract parseResponseError(response: any, xhr: XMLHttpRequest): ResponseError;
}
