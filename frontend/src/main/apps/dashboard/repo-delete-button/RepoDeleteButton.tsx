import './RepoDeleteButton.less';
import React, {useEffect, useMemo, useState, useRef} from 'react';
import {useRepoStore} from 'main/recoil/hooks';
import Icon from 'uikit/components/icon/Icon';
import ConfirmationDialog from 'uikit/components/confirmation-dialog/ConfirmationDialog';
import IRepo from 'main/models/interfaces/IRepo';
import RepoDeleteParcel from 'main/api/repo/RepoDeleteParcel';
import Request from 'libs/http-request/Request';
import __ from 'main/i18n';
import Dropdown from 'uikit/components/dropdown/Dropdown';

export default function RepoDeleteButton({repo}: { repo: IRepo }) {

    const repoStore = useRepoStore();

    const [showsConfirmation, setShowsConfirmation] = useState(false);

    const parcel = useMemo(() => new RepoDeleteParcel(repo), [repo]);

    useEffect(() => {
        return () => {
            Request.destroy(parcel);
        };
    }, [parcel]);

    const buttonRef = useRef(null);

    return (
        <>
            <button
                className="RepoDeleteButton"
                onClick={() => {
                    setShowsConfirmation(true);
                }}
                ref={buttonRef}
            >
                <Icon name="trash"/>
            </button>
            {showsConfirmation && buttonRef.current !== null && (
                <Dropdown
                    opener={buttonRef.current}
                    close={() => {
                        setShowsConfirmation(false);
                    }}
                >
                    <ConfirmationDialog
                        confirm={() => {
                            repoStore.ajaxRemove.run(parcel);
                        }}
                        cancel={() => {
                            setShowsConfirmation(false);
                        }}
                        title={__('Delete repo ::name', {name: repo.name})}
                        message={__('Are you sure you want to remove this repo? This action cannot be undone.')}
                    />
                </Dropdown>
            )}
        </>
    );
}
