import './Lane.less';
import React, {memo, useEffect} from 'react';
import IList from 'main/models/interfaces/IList';
import CardListParcel from 'main/api/card/CardListParcel';
import Request from 'libs/http-request/Request';
import Card from 'main/apps/kanban/card/Card';
import {
    Draggable,
    DraggableProvided,
    DraggableStateSnapshot,
    Droppable,
    DroppableProvided, DroppableStateSnapshot,
} from 'react-beautiful-dnd';
import useCardActions from 'main/store/card/useCardActions';
import NewCard from 'main/apps/kanban/new-card/NewCard';
import useCardData from 'main/store/card/useCardData';

export default memo(function Lane(
    {
        list,
        isDropDisabled = false,
    }: {
        list: IList,
        isDropDisabled?: boolean,
    },
) {
    const cardActions = useCardActions();
    const cardData = useCardData();

    const cards = cardData.entities.filter(t => t.listId === list.id);

    useEffect(() => {
        const parcel = new CardListParcel(list.id);
        cardActions.ajaxList.run(parcel);

        return () => {
            Request.destroy(parcel);
        };
    }, [list]);

    return (
        <Droppable droppableId={list.id} isDropDisabled={isDropDisabled}>
            {(provided: DroppableProvided, snapshot: DroppableStateSnapshot) => (
                <div
                    className={[
                        'Lane',
                        isDropDisabled && 'is-drop-disabled',
                        snapshot.isDraggingOver && 'is-dragging-over',
                    ]}
                    ref={provided.innerRef}
                    {...provided.droppableProps}
                >
                    <h3 className="title">
                        {list.title}
                    </h3>
                    <div className="content">
                        {cards.map((card, index) => (
                            <Draggable key={card.id} draggableId={card.id} index={index}>
                                {(provided: DraggableProvided, snapshot: DraggableStateSnapshot) => (
                                    <div
                                        className={[
                                            'card-holder',
                                            snapshot.isDragging && 'is-dragging',
                                        ]}
                                        ref={provided.innerRef}
                                        {...provided.draggableProps}
                                        {...provided.dragHandleProps}
                                    >
                                        <Card card={card}/>
                                    </div>
                                )}
                            </Draggable>
                        ))}
                        {provided.placeholder}
                        <NewCard listId={list.id}/>
                    </div>
                </div>
            )}
        </Droppable>
    );
});
