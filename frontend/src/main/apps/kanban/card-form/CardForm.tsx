import './CardForm.less';
import React, {useMemo} from 'react';
import __ from 'main/i18n';
import {AjaxAction} from 'main/store/interfaces';
import ICard from 'main/models/interfaces/ICard';
import Parcel from 'libs/http-request/Parcel';
import TextArea from 'uikit/components/text-area/TextArea';
import Button from 'uikit/components/button/Button';
import Spinner from 'uikit/components/spinner/Spinner';
import {shallowEqual} from 'libs/utils/object';
import validateCard from 'main/models/validation/validateCard';
import ResponseError from 'libs/http-request/ResponseError';

export default function CardForm(
    {
        values,
        setValues,
        action,
        parcel,
        onSuccess,
        onError,
        onCancel,
    }: {
        values: ICard,
        setValues: React.Dispatch<React.SetStateAction<ICard>>,
        action: AjaxAction<ICard>,
        parcel: Parcel<ICard>,
        onSuccess?: (card: ICard) => void,
        onError?: (error: ResponseError) => void,
        onCancel?: () => void,
    },
) {
    const initialValues = useMemo(() => ({...values}), []);
    const {inProgress, error} = action.state;

    const hasChanges = !shallowEqual(values, initialValues);
    const validationMessage = validateCard(values);
    const disabled = !hasChanges || validationMessage !== null;

    return (
        <form
            className="CardForm"
            onSubmit={(ev) => {
                ev.preventDefault();
                action.run(parcel).then(onSuccess).catch(onError);
            }}
        >
            <div className="content">
                <TextArea
                    value={values.text}
                    setValue={text => {
                        setValues({...values, text});
                    }}
                    rows={6}
                    autoFocus
                    readOnly={inProgress}
                    placeholder={__('Enter text for this card')}
                />
                {error !== null && (
                    <div className="error">
                        {error.message}
                    </div>
                )}
            </div>
            <div className="actions">
                <Button
                    title={validationMessage !== null ? validationMessage : __('Save')}
                    type="submit"
                    iconOnly
                    icon={inProgress ? <Spinner/> : 'tick'}
                    appearance="text-primary"
                    disabled={disabled}
                    readOnly={inProgress}
                />
                {onCancel && (
                    <Button
                        title={__('Cancel')}
                        type="reset"
                        iconOnly
                        icon="times"
                        appearance="text-danger"
                        onClick={() => {
                            onCancel();
                        }}
                        disabled={inProgress}
                    />
                )}
            </div>
        </form>
    );
}
