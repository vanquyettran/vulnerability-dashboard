import './CardDetailedView.less';
import React, {useState} from 'react';
import ICard from 'main/models/interfaces/ICard';
import TextArea from 'uikit/components/text-area/TextArea';
import useCardActions from 'main/store/card/useCardActions';
import CardUpdateParcel from 'main/api/card/CardUpdateParcel';
import __ from 'main/i18n';
import Button from 'uikit/components/button/Button';
import useListData from 'main/store/list/useListData';
import Toasts, {TOAST_ERROR} from 'uikit/components/toast/Toasts';
import {shallowEqual} from 'libs/utils/object';

export default function CardDetailedView({card, onClose}: {card: ICard, onClose: () => void}) {
    const {ajaxDraftUpdate} = useCardActions();
    const listData = useListData();
    const list = listData.findById(card.listId);
    const [draftCard, setDraftCard] = useState({...card});

    const runBackgroundUpdate = () => {
        if (shallowEqual(draftCard, card)) {
            return;
        }
        ajaxDraftUpdate.run(new CardUpdateParcel(draftCard))
            .catch((error) => {
                setDraftCard(card);
                Toasts.add(TOAST_ERROR, error.message);
            });
    };

    return (
        <div className="CardDetailedView">
            <div className="heading">
                <TextArea
                    value={draftCard.text}
                    setValue={text => {
                        setDraftCard(draftCard => ({...draftCard, text}));
                    }}
                    onBlur={() => {
                        runBackgroundUpdate();
                    }}
                />
                <Button
                    title={__('Close')}
                    iconOnly
                    icon="times"
                    appearance="text-neutral"
                    onClick={() => {
                        onClose();
                    }}
                />
            </div>
            <div className="meta">
                {list && (
                    <div className="status" title={__('Not implemented yet')}>
                        <span>{list.title}</span>
                    </div>
                )}
            </div>
            <div className="body">
                <label>{__('Notes')}</label>
                <TextArea
                    value={draftCard.note}
                    setValue={note => {
                        setDraftCard(draftCard => ({...draftCard, note}));
                    }}
                    onBlur={() => {
                        runBackgroundUpdate();
                    }}
                    placeholder={__('Add notes...')}
                    minRows={5}
                    multipleLines
                />
            </div>
        </div>
    );
}
