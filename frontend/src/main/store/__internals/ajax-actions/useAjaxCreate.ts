import {useState} from 'react';
import {AjaxAction, AjaxState, EntityDataManipulation} from 'main/store/interfaces';
import ResponseError from 'libs/http-request/ResponseError';
import __ from 'main/i18n';
import Request from 'libs/http-request/Request';
import IEntity from 'main/models/interfaces/IEntity';

export default function useAjaxCreate<T extends IEntity>(
    addOrReplace: (entity: T) => void,
    middlewareFn: (entity: T, callback: () => void) => void = ((entity, callback) => callback()),
): AjaxAction<T> {
    const [state, setState] = useState<AjaxState>({inProgress: false, error: null});

    const run: EntityDataManipulation<T>['ajaxCreate']['run'] = (parcel) => {
        if (state.inProgress) {
            return Promise.reject(new ResponseError(__('The process is running')));
        }

        if (parcel.getPayloadError() !== null) {
            return Promise.reject(new ResponseError(parcel.getPayloadError()));
        }

        setState({inProgress: true, error: null});

        return new Promise((resolve, reject) => {
            Request.add(parcel)
                .then(entity => {
                    middlewareFn(entity, () => {
                        setState({inProgress: false, error: null});
                        addOrReplace(entity);
                        resolve(entity);
                    });
                })
                .catch(error => {
                    setState({inProgress: false, error: error});
                    reject(error);
                });
        });
    };

    return {run, state};
}
