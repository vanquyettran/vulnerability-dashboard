import {useSetRecoilState} from 'recoil';
import {repoData} from './atoms';
import {RepoDataManipulation} from './interfaces';
import createDraftList from 'main/models/factory/createDraftList';
import ListCreateParcel from 'main/api/list/ListCreateParcel';
import useListActions from 'main/store/useListActions';
import useAjaxCreate from 'main/store/ajax-actions/useAjaxCreate';
import useAjaxList from 'main/store/ajax-actions/useAjaxList';
import useAjaxRead from 'main/store/ajax-actions/useAjaxRead';
import useAjaxUpdate from 'main/store/ajax-actions/useAjaxUpdate';
import useAjaxDraftUpdate from 'main/store/ajax-actions/useAjaxDraftUpdate';
import useAjaxDelete from 'main/store/ajax-actions/useAjaxDelete';
import manipulateData from 'main/store/manipulateData';

export default function useRepoActions(): RepoDataManipulation {
    const {addOrReplace, update, removeById, reorder, swap} = manipulateData(useSetRecoilState(repoData));
    const listMani = useListActions();

    return {
        ajaxList: useAjaxList(addOrReplace),
        ajaxRead: useAjaxRead(addOrReplace),
        ajaxCreate: useAjaxCreate(addOrReplace, (createdRepo, callback) => {
            const draftLists = [
                'Open',
                'Confirmed',
                'False Positive',
                'Fixed',
            ].map(title => createDraftList({title}));

            // Create lists sequentially:
            // to maintain the order
            // and AjaxAction does not support parallel running
            const promise = draftLists.reduce((promise, list) => {
                return promise.finally(() => {
                    return listMani.ajaxCreate.run(new ListCreateParcel(createdRepo.id, list));
                });
            }, Promise.resolve());

            promise.finally(callback);
        }),
        ajaxUpdate: useAjaxUpdate(update),
        ajaxDraftUpdate: useAjaxDraftUpdate(update),
        ajaxDelete: useAjaxDelete(removeById, (deletedRepo, callback) => {
            // TODO: Implement DELETE CASCADE
            callback();
        }),
        reorder,
        swap,
    };
}
